name: Helm Chart Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (no prefix)'
        required: true
        type: string
      internal:
        description: 'Is it an internal release?'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    outputs:
      full_tag: ${{ steps.parse.outputs.full_tag }}
      environment: ${{ steps.parse.outputs.environment }}

    steps:
      - name: Determine environment
        id: parse
        env:
          VERSION: ${{ inputs.version }}
          ENVIRONMENT: ${{ inputs.internal && 'dev' || 'production' }}
        run: |
          echo "Version: $VERSION"
          
          FULL_TAG="helm-chart-v$VERSION"
          echo "Full tag: $FULL_TAG"
          echo "full_tag=$FULL_TAG" >> $GITHUB_OUTPUT
          
          echo "Environment: $ENVIRONMENT"
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

  release:
    needs: calculate-version
    runs-on: ubuntu-latest
    environment: ${{ needs.calculate-version.outputs.environment }}
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GATLING_CI_TOKEN }}

      - name: Configure Git
        env:
          GIT_USER_NAME: ${{ secrets.GATLING_CI_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GATLING_CI_EMAIL }}
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

      - name: Display release information
        env:
          FULL_TAG: ${{ needs.calculate-version.outputs.full_tag }}
          VERSION: ${{ github.event.inputs.version }}
          ENVIRONMENT: ${{ needs.calculate-version.outputs.environment }}
        run: |
          echo "ðŸš€ Preparing Helm chart release"
          echo "Full tag: $FULL_TAG"
          echo "Chart version: $VERSION"
          echo "Environment: $ENVIRONMENT"

      - name: Update Chart.yaml with version
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          sed -i "s/^version:.*/version: $VERSION/" helm-chart/Chart.yaml
          
          echo "âœ“ Updated Chart.yaml to version $VERSION"
          grep -E '^version:' helm-chart/Chart.yaml

      - name: Commit version change
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          git add helm-chart/Chart.yaml
          git commit -m "chore: bump helm chart version to $VERSION"

      - name: Create and push tag
        env:
          TAG: ${{ needs.calculate-version.outputs.full_tag }}
        run: |
          git tag "$TAG"
          git push origin "$TAG"
          echo "âœ“ Created and pushed tag: $TAG"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Lint Helm chart
        run: |
          helm lint helm-chart/

      - name: Package Helm chart
        run: |
          helm package helm-chart/ --destination ./packaged-charts/
          echo "Packaged chart:"
          ls -lh ./packaged-charts/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.SE_HELM_AWS_ROLE }}
          aws-region: ${{ vars.SE_HELM_AWS_S3_REGION }}

      - name: Deploy public to S3
        env:
          S3_BUCKET: ${{ vars.SE_HELM_AWS_S3_BUCKET }}
          S3_REGION: ${{ vars.SE_HELM_AWS_S3_REGION }}
          HELM_REPO_URL: ${{ vars.SE_HELM_BASE_URL }}
        run: |
          PAGE_TITLE="Helm Repository"
          
          sed -i "s|{{PAGE_TITLE}}|${PAGE_TITLE}|g" ./helm-chart/public/index.html
          sed -i "s|{{HELM_REPO_URL}}|\"${HELM_REPO_URL}\"|g" ./helm-chart/public/index.html
          aws s3 cp ./helm-chart/public/index.html "s3://${S3_BUCKET}/index.html"
          aws s3 cp ./helm-chart/public/gatling.png "s3://${S3_BUCKET}/gatling.png"
          aws s3 cp ./helm-chart/public/favicon.ico "s3://${S3_BUCKET}/favicon.ico"

      - name: Upload to S3
        env:
          S3_BUCKET: ${{ vars.SE_HELM_AWS_S3_BUCKET }}
          S3_REGION: ${{ vars.SE_HELM_AWS_S3_REGION }}
          VERSION: ${{ github.event.inputs.version }}
        run: |
          CHART_FILE="enterprise-locations-packages-${VERSION}.tgz"
          
          aws s3 cp "./packaged-charts/$CHART_FILE" \
            "s3://${S3_BUCKET}/charts/$CHART_FILE" \
            --region ${S3_REGION}
          
          echo "âœ“ Chart uploaded to s3://${S3_BUCKET}/$CHART_FILE"

      - name: Update Helm repository index
        env:
          S3_BUCKET: ${{ vars.SE_HELM_AWS_S3_BUCKET }}
          S3_REGION: ${{ vars. SE_HELM_AWS_S3_REGION }}
          HELM_REPO_URL: ${{ vars.SE_HELM_BASE_URL }}
        run: |
          aws s3 cp "s3://${S3_BUCKET}/index.yaml" ./index.yaml \
            --region ${S3_REGION} || echo "index.yaml not found, will create new one"
          
          helm repo index ./packaged-charts/ \
            --url "${HELM_REPO_URL}/charts" \
            --merge ./index.yaml || helm repo index ./packaged-charts/ \
            --url "${HELM_REPO_URL}/charts"
          
          aws s3 cp ./packaged-charts/index.yaml \
            "s3://${S3_BUCKET}/index.yaml" \
            --region ${S3_REGION}
          
          echo "âœ“ Repository index updated at /index.yaml"

      - name: Create CloudFront invalidation (dev)
        if: needs.calculate-version.outputs.environment == 'dev'
        env:
          CLOUDFRONT_DISTRIBUTION_ID: ${{ vars.SE_HELM_AWS_CLOUDFRONT_DISTRIBUTION_ID }}
        run: aws cloudfront create-invalidation --distribution-id ${CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"

      - name: Create CloudFront invalidation (production)
        if: needs.calculate-version.outputs.environment == 'production'
        env:
          DOCUMENT_NAME: ${{ vars.CLOUDFRONT_INVALIDATION_DOCUMENT }}
        run: |
          aws ssm start-automation-execution \
            --region eu-west-3 \
            --document-name "${DOCUMENT_NAME}"


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.calculate-version.outputs.full_tag }}
          name: Helm Chart ${{ github.event.inputs.version }}
          files: ./packaged-charts/*.tgz
          draft: ${{ needs.calculate-version.outputs.environment != 'production' }}
          token: ${{ secrets.GATLING_CI_TOKEN }}
          body: |
            ## Helm Chart Release ${{ github.event.inputs.version }}
            
            **Type**: ${{ needs.calculate-version.outputs.environment == 'production' && 'âœ… Production Release' || 'ðŸš§ Milestone (Development)' }}
            **Environment**: ${{ needs.calculate-version.outputs.environment }}
            **Bump**: ${{ github.event.inputs.bump }}
            
            ### Installation
            
            ```bash
            # Add the Helm repository
            helm repo add ${{ vars.SE_HELM_REPO_NAME }} ${{ vars.SE_HELM_BASE_URL }}
            
            # Update repositories
            helm repo update
            
            # Install the chart
            helm install gatling-control-plane ${{ vars.SE_HELM_REPO_NAME }}/enterprise-locations-packages --version ${{ github.event.inputs.version }}
            ```
            
            ### Changes
            - Changelog: See commit history for details
